name: Add GitHub Actions Role to EKS

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  eks-auth:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
      GHA_EKS_ROLE_ARN: ${{ secrets.AWS_ROLE_EKS_ARN }}
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_EKS_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name "${EKS_CLUSTER_NAME}" --region "${AWS_REGION}"

      - name: Patch aws-auth ConfigMap
        run: |
          # Check if role is already present
          if ! kubectl get configmap aws-auth -n kube-system -o yaml | grep -q "${GHA_EKS_ROLE_ARN}"; then
            echo "Adding GitHub Actions role to aws-auth ConfigMap..."
            kubectl patch configmap aws-auth -n kube-system --type=json \
              -p="[
                {
                  \"op\": \"add\",
                  \"path\": \"/data/mapRoles/-\",
                  \"value\": \"- rolearn: ${GHA_EKS_ROLE_ARN}\n  username: gha\n  groups:\n    - system:masters\"
                }
              ]"
          else
            echo "Role already exists in aws-auth. Skipping."
          fi

      - name: Verify access
        run: kubectl get ns
