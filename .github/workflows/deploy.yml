name: Deploy to EKS

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build and Push Images"]
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: build  # if invoked by same workflow; remove if separate workflows and using artifacts
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
      EKS_NAMESPACE: ${{ secrets.EKS_NAMESPACE }}
      DB_SSM_PATH: ${{ secrets.DB_SSM_PATH }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_NAME: ${{ secrets.DB_NAME }}
      BACKEND_REPO: ${{ secrets.ECR_BACKEND_REPO }}
      FRONTEND_REPO: ${{ secrets.ECR_FRONTEND_REPO }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region "${{ env.AWS_REGION }}" --name "${{ env.EKS_CLUSTER_NAME }}"

      - name: Ensure namespace exists
        run: kubectl apply -f k8s/namespace.yaml

      - name: Create / Update DB Secret in Kubernetes (from SSM)
        id: create_secret
        run: |
          # Read DB password from SSM (must have ssm:GetParameter)
          DB_PASS=$(aws ssm get-parameter --name "${DB_SSM_PATH}" --with-decryption --query Parameter.Value --output text)
          # Create or replace k8s secret (non-sensitive values will be stored in secret as well)
          kubectl create namespace ${EKS_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
          kubectl delete secret book-review-backend-env -n ${EKS_NAMESPACE} --ignore-not-found
          kubectl create secret generic book-review-backend-env -n ${EKS_NAMESPACE} \
            --from-literal=DB_HOST="${{ secrets.DB_HOST }}" \
            --from-literal=DB_NAME="${DB_NAME}" \
            --from-literal=DB_USER="${DB_USERNAME}" \
            --from-literal=DB_PASS="${DB_PASS}" \
            --from-literal=DB_DIALECT="mysql" \
            --from-literal=JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --from-literal=ALLOWED_ORIGINS="*" || true

      - name: Apply k8s manifests
        run: kubectl apply -n ${EKS_NAMESPACE} -f k8s/

      - name: Update backend image
        if: needs.build.outputs.backend_image != ''
        run: |
          IMAGE=${{ needs.build.outputs.backend_image }}
          kubectl -n ${EKS_NAMESPACE} set image deployment/book-review-backend backend=${IMAGE}

      - name: Update frontend image
        if: needs.build.outputs.frontend_image != ''
        run: |
          IMAGE=${{ needs.build.outputs.frontend_image }}
          kubectl -n ${EKS_NAMESPACE} set image deployment/book-review-frontend frontend=${IMAGE}

      - name: Wait for rollouts
        run: |
          kubectl rollout status deployment/book-review-backend -n ${EKS_NAMESPACE} --timeout=120s
          kubectl rollout status deployment/book-review-frontend -n ${EKS_NAMESPACE} --timeout=120s
